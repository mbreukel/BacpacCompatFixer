@page "/"
@using BacpacCompatFixer.Blazor.Services
@using BacpacCompatFixer.Blazor.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IPurchaseVerificationService PurchaseService
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<PageTitle>BacpacCompatFixer</PageTitle>

<div class="container mt-4">
    <h1 class="text-primary">BacpacCompatFixer</h1>
    <p class="lead">Removes XTP and AlwaysOn features from model.xml to restore import compatibility</p>

    <AuthorizeView>
        <Authorized>
            <div class="alert alert-success mb-4">
                <h5>✅ You are signed in</h5>
                <p class="mb-0">You are signed in as <strong>@context.User.Identity?.Name</strong>. You can now use the service.</p>
            </div>
        </Authorized>
        <NotAuthorized>
            <div class="alert alert-info mb-4">
                <h5>🔐 Authentication Required</h5>
                <p class="mb-0">Sign in with your Microsoft account to use this service. Both personal and business accounts (Azure AD/Entra ID) are supported.</p>
            </div>
        </NotAuthorized>
    </AuthorizeView>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">What does it do?</h5>
                </div>
                <div class="card-body">
                    <p>This tool removes all elements and attributes related to AlwaysOn and XTP (In-Memory OLTP) from model.xml in a .bacpac archive and updates the checksum in origin.xml.</p>
                    <p>This makes the .bacpac importable on SQL Server instances that don't support these features.</p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Features</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li>Secure authentication with Microsoft accounts</li>
                        <li>Upload .bacpac files directly</li>
                        <li>Removes AlwaysOn and XTP references</li>
                        <li>Updates checksums automatically</li>
                        <li>Download processed files</li>
                        <li>Automatic cleanup of temporary files</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card mb-3 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">🆓 Free Tier</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li>Upload files up to <strong>500 MB</strong></li>
                        <li>All core features included</li>
                        <li>Secure authentication</li>
                        <li>No credit card required</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">⭐ Premium Tier</h5>
                </div>
                <div class="card-body">
                    @if (purchaseStatus?.HasPurchased == true && purchaseStatus.Status == SubscriptionStatus.Active)
                    {
                        <div class="alert alert-success mb-2">
                            <strong>✅ You have Premium!</strong>
                        </div>
                    }
                    <ul>
                        <li>Upload files up to <strong>5 GB</strong></li>
                        <li>All core features included</li>
                        <li>Priority support</li>
                        <li>Available via Microsoft Marketplace</li>
                    </ul>
                    @if (purchaseStatus?.HasPurchased != true || purchaseStatus?.Status != SubscriptionStatus.Active)
                    {
                        <p class="mb-0"><small><a href="https://marketplace.microsoft.com/en-us/product/saas/breukel.bacpaccompatfixer?tab=Overview" target="_blank" rel="noopener noreferrer" aria-label="Get Premium on Microsoft Marketplace (opens in new tab)">Get Premium on Microsoft Marketplace</a></small></p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info mt-3" role="alert">
        <h5>Common Errors This Fixes</h5>
        <p><strong>Error SQL72014:</strong> AlwaysOn availability group replicas is disabled on this SQL Server instance.</p>
        <p><strong>Error SQL72045:</strong> Script execution error related to XTP filegroups.</p>
    </div>

    <div class="text-center mt-4">
        <a href="/bacpacfixer" class="btn btn-primary btn-lg">
            <span class="bi bi-tools" aria-hidden="true"></span> Go to BacpacFixer Tool
        </a>
    </div>

    <div class="card mt-5 border-secondary">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">About This Service</h5>
        </div>
        <div class="card-body">
            <p>This is a service provided by <strong>Breukel Software GmbH</strong>, based on the free GitHub repository <a href="https://github.com/mbreukel/BacpacCompatFixer" target="_blank" rel="noopener noreferrer">@@mbreukel/BacpacCompatFixer</a>.</p>
            <p>The project is licensed under the <strong>MIT License</strong>. For more details, please refer to the repository.</p>
            <p class="mb-0"><em>Special thanks to GitHub Copilot for assistance in developing this application.</em></p>
        </div>
    </div>
</div>

@code {
    private UserPurchaseStatus? purchaseStatus;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value 
                ?? user.FindFirst("oid")?.Value 
                ?? user.FindFirst("sub")?.Value;
            
            if (!string.IsNullOrEmpty(userId))
            {
                purchaseStatus = await PurchaseService.VerifyPurchaseAsync(userId);
            }
        }
    }
}
