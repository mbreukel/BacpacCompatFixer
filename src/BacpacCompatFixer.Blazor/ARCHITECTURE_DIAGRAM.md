# ??? Architektur-Übersicht: API-basierte Subscription-Verifizierung

```
???????????????????????????????????????????????????????????????????????????
?                         USER LOGIN FLOW                                  ?
???????????????????????????????????????????????????????????????????????????

????????????
?  User    ?  Login mit E-Mail: user@example.com
?  Logs In ?
????????????
     ?
     ?
???????????????????????????????????????????????????????????????????????
?  RealTimePurchaseVerificationService                                ?
?  VerifyPurchaseAsync(user@example.com)                              ?
???????????????????????????????????????????????????????????????????????
     ?
     ??????? Check Memory Cache (5 Min)
     ?       ??? Cache Hit? ? Return cached UserPurchaseStatus ?
     ?
     ? Cache Miss
     ?
???????????????????????????????????????????????????????????????????????
?  MarketplaceAuthService                                              ?
?  GetAccessTokenAsync()                                               ?
???????????????????????????????????????????????????????????????????????
     ?
     ??????? Check Token Cache (~55 Min)
     ?       ??? Valid? ? Return cached token ?
     ?
     ? Token expired/missing
     ?
     ??????? POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token
     ?       ?? grant_type: client_credentials
     ?       ?? client_id: {ClientId}
     ?       ?? client_secret: {ClientSecret}
     ?       ?? scope: 20e940b3-4c77-4b0b-9a53-9e16a1b010a7/.default
     ?
     ?????? Response: { access_token, expires_in: 3600 }
     ?
     ??????? Cache Token (55 Min)
     ?
     ?
???????????????????????????????????????????????????????????????????????
?  MarketplaceApiService                                               ?
?  GetSubscriptionByUserEmailAsync(user@example.com)                   ?
???????????????????????????????????????????????????????????????????????
     ?
     ?
     ?
     ??????? GET https://marketplaceapi.microsoft.com/api/saas/subscriptions
     ?       ?? Authorization: Bearer {access_token}
     ?
     ?????? Response: {
     ?         "subscriptions": [
     ?           {
     ?             "id": "sub-123",
     ?             "beneficiary": { "emailId": "user@example.com" },
     ?             "planId": "premium",
     ?             "saasSubscriptionStatus": "Subscribed"
     ?           }
     ?         ]
     ?       }
     ?
     ?
     ?
     ??????? Filter: Find subscription where
             - beneficiary.emailId == "user@example.com"
             - saasSubscriptionStatus == "Subscribed"
     ?
     ? Found: sub-123 with planId "premium"
     ?
???????????????????????????????????????????????????????????????????????
?  Check Premium Status                                                ?
?  IsPremiumPlan("premium")                                            ?
???????????????????????????????????????????????????????????????????????
     ?
     ??????? Load PremiumPlanIds from appsettings.json
     ?       ["premium", "pro", "enterprise"]
     ?
     ??????? Check: "premium" in PremiumPlanIds?
     ?       ??? YES ?
     ?
     ?
     ?
???????????????????????????????????????????????????????????????????????
?  Create UserPurchaseStatus                                           ?
?  {                                                                   ?
?    UserId: "user@example.com",                                       ?
?    HasPurchased: true,                                               ?
?    Status: Active,                                                   ?
?    PlanId: "premium",                                                ?
?    SubscriptionId: "sub-123",                                        ?
?    MaxFileSizeBytes: 5GB                                             ?
?  }                                                                   ?
???????????????????????????????????????????????????????????????????????
     ?
     ??????? Cache Result (5 Min)
     ?
     ?
???????????????????????????????????????????????????????????????????????
?  Return to Application                                               ?
?  ? User has Premium Access ?                                        ?
?  ? Max File Size: 5GB                                                ?
???????????????????????????????????????????????????????????????????????
```

---

## ?? Komponenten-Diagramm

```
?????????????????????????????????????????????????????????????????????
?                      BLAZOR APPLICATION                            ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?  Blazor Components / Controllers                          ?    ?
?  ?  - Upload.razor                                           ?    ?
?  ?  - AccountController.cs                                   ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                      ?                                             ?
?                      ? Inject IPurchaseVerificationService        ?
?                      ?                                             ?
?  ????????????????????????????????????????????????????????????    ?
?  ?  RealTimePurchaseVerificationService                      ?    ?
?  ?  ?? VerifyPurchaseAsync()                                 ?    ?
?  ?  ?? GetSubscriptionByIdAsync()                            ?    ?
?  ?  ?? UpdateSubscriptionAsync()                             ?    ?
?  ?  ?? IsPremiumPlan()                                       ?    ?
?  ????????????????????????????????????????????????????????????    ?
?      ?                                ?                           ?
?      ? Uses                           ? Uses                      ?
?      ?                                ?                           ?
?  ??????????????????????          ????????????????????????        ?
?  ? MarketplaceApiSvc  ?          ?  IMemoryCache        ?        ?
?  ? ?? GetAllSubs()    ?          ?  (5 Min Cache)       ?        ?
?  ? ?? GetSubById()    ?          ????????????????????????        ?
?  ? ?? GetSubByEmail() ?                                           ?
?  ??????????????????????                                           ?
?      ? Uses                                                       ?
?      ?                                                            ?
?  ??????????????????????                                           ?
?  ? MarketplaceAuthSvc ?                                           ?
?  ? ?? GetAccessToken()?                                           ?
?  ??????????????????????                                           ?
?      ?                                                            ?
?????????????????????????????????????????????????????????????????????
       ?
       ? HTTP Requests
       ?
?????????????????????????????????????????????????????????????????????
?                    MICROSOFT SERVICES                              ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?  Azure Active Directory                                   ?    ?
?  ?  POST /oauth2/v2.0/token                                  ?    ?
?  ?  ? Returns: Access Token (60 min)                         ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?  Marketplace Fulfillment API                              ?    ?
?  ?  GET /api/saas/subscriptions                              ?    ?
?  ?  GET /api/saas/subscriptions/{id}                         ?    ?
?  ?  ? Returns: Subscription Details                          ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?  Marketplace Webhook Service                              ?    ?
?  ?  POST /api/marketplacewebhook                             ?    ?
?  ?  ? Sends: Subscription Change Events                      ?    ?
?  ????????????????????????????????????????????????????????????    ?
?????????????????????????????????????????????????????????????????????
```

---

## ?? Webhook-Integration

```
?????????????????????????????????????????????????????????????????????
?                    WEBHOOK EVENT FLOW                              ?
?????????????????????????????????????????????????????????????????????

Microsoft Marketplace
      ?
      ? User changes subscription
      ? (ChangePlan, Unsubscribe, etc.)
      ?
POST /api/marketplacewebhook
  {
    "subscriptionId": "sub-123",
    "planId": "premium",
    "action": "ChangePlan",
    "purchaser": {
      "emailId": "user@example.com"
    }
  }
      ?
      ?
???????????????????????????????????????????
?  MarketplaceWebhookController           ?
?  ?? Validate JWT Token                  ?
?  ?? Process Event                       ?
???????????????????????????????????????????
        ?
        ?
???????????????????????????????????????????
?  RealTimePurchaseVerificationService    ?
?  UpdateSubscriptionAsync()              ?
???????????????????????????????????????????
        ?
        ??????? Invalidate Cache for user@example.com
        ?       _cache.Remove("purchase_status_user@example.com")
        ?
        ??????? Next login will fetch fresh data from API ?
```

---

## ?? Caching-Strategie

```
?????????????????????????????????????????????????????????????????????
?                      MEMORY CACHE                                  ?
?????????????????????????????????????????????????????????????????????

Cache Key Format:
  "purchase_status_{userEmail}"
  
Cache Duration:
  5 Minutes (configurable)
  
Cache Invalidation:
  ? Automatic: After 5 minutes
  ? Manual: Webhook events
  ? Manual: UpdateSubscriptionAsync()

???????????????????????????????????????????????????????????????????
?  Time: 10:00:00 - First Login                                   ?
?  ?? Cache Miss                                                  ?
?  ?? API Call: GET /api/saas/subscriptions                      ?
?  ?? Response: User has Premium                                 ?
?  ?? Cache until 10:05:00                                        ?
???????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????
?  Time: 10:02:00 - Second Login (within 5 min)                  ?
?  ?? Cache Hit ?                                                ?
?  ?? Return cached status                                        ?
?  ?? NO API Call (Performance!)                                  ?
???????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????
?  Time: 10:03:00 - Webhook: User downgrades to Free             ?
?  ?? Cache Invalidated                                           ?
?  ?? Next login will fetch fresh data                            ?
???????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????
?  Time: 10:04:00 - Third Login (after webhook)                  ?
?  ?? Cache Miss (invalidated by webhook)                        ?
?  ?? API Call: GET /api/saas/subscriptions                      ?
?  ?? Response: User now has Free                                ?
?  ?? Cache until 10:09:00                                        ?
???????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????
?  Time: 10:06:00 - Fourth Login (cache from 10:00 expired)      ?
?  ?? Cache Miss (expired)                                        ?
?  ?? API Call: GET /api/saas/subscriptions                      ?
?  ?? Response: Current status                                    ?
?  ?? Cache until 10:11:00                                        ?
???????????????????????????????????????????????????????????????????
```

---

## ?? Decision Tree: Premium vs. Free

```
User Login
    ?
    ?
Get Subscription from API
    ?
    ??? Subscription Found?
    ?   ?
    ?   NO ??????????????????????????? FREE TIER
    ?   ?                               - MaxFileSize: 500MB
    ?   ?                               - Status: Free
    ?   ?
    ?   YES
    ?   ?
    ?   ?
    ?   Subscription Status == "Subscribed"?
    ?   ?
    ?   NO ??????????????????????????? FREE TIER
    ?   ?                               - Status: Suspended/Unsubscribed
    ?   ?
    ?   YES
    ?   ?
    ?   ?
    ?   PlanId in PremiumPlanIds?
    ?   ?
    ?   NO ??????????????????????????? FREE TIER
    ?   ?                               - Status: Free
    ?   ?                               - Has non-premium plan
    ?   ?
    ?   YES
    ?   ?
    ?   ?
    ?   PREMIUM TIER ?
    ?   - MaxFileSize: 5GB
    ?   - Status: Active
    ?   - HasPurchased: true
    ?
    ????? Return UserPurchaseStatus
```

---

## ?? Performance-Metriken

```
?????????????????????????????????????????????????????????????????????
?                    RESPONSE TIMES                                  ?
?????????????????????????????????????????????????????????????????????

Cache Hit (< 5 Min):
  ???? ~1ms
  
Cache Miss + API Call:
  ???????????????????????????????? ~50-200ms
  
Token Refresh (hourly):
  ???????????????? ~100ms (async, cached for 55 min)

?????????????????????????????????????????????????????????????????????
?                    API CALLS PER HOUR                              ?
?????????????????????????????????????????????????????????????????????

Without Cache:
  100 Users × 60 Logins/Hour = 6,000 API Calls
  ???????????????????????????????????????????????????????????? 6000

With 5-Min Cache:
  100 Users × 12 Logins/Hour = 1,200 API Calls
  ???????????? 1200
  
Reduction: 80% fewer API calls! ??
```

---

## ?? Security-Flow

```
?????????????????????????????????????????????????????????????????????
?                    AUTHENTICATION FLOW                             ?
?????????????????????????????????????????????????????????????????????

appsettings.json (Production: Azure Key Vault)
    ?
    ?? TenantId: "your-tenant-id"
    ?? ClientId: "your-client-id"
    ?? ClientSecret: "********" ? NEVER in Git!
    ?
    ?
Azure AD Token Request
    ?
    POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token
    ?
    ?
Access Token (JWT)
    ?
    ?? Valid for: 60 minutes
    ?? Cached for: 55 minutes
    ?? Scoped to: Marketplace API
    ?
    ?
Marketplace API Request
    ?
    Authorization: Bearer {access_token}
    ?
    ?
Subscription Data
    ?
    ??? Cached for 5 minutes
```

---

**Dokumentation erstellt:** 2025-01-15  
**Version:** 2.0 (API-basiert)
